def calculate_refund_or_charge(self, returned_items: list, new_items: list) -> dict:
        """
        Tính toán tổng giá trị sản phẩm được trả và sản phẩm mới được đổi.
        """
        # (1) Tính tổng giá trị sản phẩm trả lại (dựa trên giá lúc mua)
        total_returned_value = 0
        for item in returned_items:
            # Giá bán lẻ tại thời điểm mua hàng
            total_returned_value += item["price_at_sale"] * item["quantity"]

        # (2) Tính tổng giá trị sản phẩm đổi (dựa trên giá hiện tại)
        total_new_value = 0
        for item in new_items:
            # Lấy giá hiện tại hoặc giá khuyến mãi
            current_price = get_product_current_price(item["product_id"])
            total_new_value += current_price * item["quantity"]

        # (3) Tính chênh lệch
        # Chênh lệch dương (> 0): Cần hoàn tiền lại cho khách
        # Chênh lệch âm (< 0): Khách cần trả thêm
        price_difference = total_returned_value - total_new_value

        return {
            "total_returned_value": total_returned_value,
            "total_new_value": total_new_value,
            "difference": price_difference,
            "action": "REFUND" if price_difference > 0 else ("CHARGE" if price_difference < 0 else "NONE")
        }